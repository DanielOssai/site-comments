<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Comments</title>
</head>
<body style="margin:0;background:transparent;">
  <div style="max-width:820px;margin:18px auto;padding:0 12px;font-family:Arial, sans-serif;line-height:1.35;">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
      <div style="display:flex;align-items:baseline;gap:10px;flex-wrap:wrap;">
        <h3 style="margin:0;">Comments</h3>
        <div id="threadLabel" style="font-size:12px;opacity:.65;"></div>
      </div>
      <div style="font-size:13px;opacity:.8;">
        Total: <span id="totalCount">0</span>
      </div>
    </div>

    <div id="notice" style="margin:10px 0 14px 0;font-size:13px;"></div>

    <div id="adminBar" style="display:none;border:1px solid #e6e6e6;border-radius:12px;background:#fff;padding:10px 12px;margin-bottom:12px;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
        <div style="font-size:13px;">
          Admin mode on (see pending, approve, delete)
        </div>
        <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;">
          <input id="postAsAuthor" type="checkbox" />
          Post as Author
        </label>
      </div>
    </div>

    <div style="border:1px solid #ddd;border-radius:12px;padding:12px;background:#fff;">
      <div style="display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap;">
        <div style="display:flex;align-items:center;gap:10px;min-width:260px;">
          <div style="width:34px;height:34px;border-radius:999px;display:grid;place-items:center;background:#f2f2f2;border:1px solid #e6e6e6;">
            <span style="font-size:18px;">üë§</span>
          </div>
          <div style="display:flex;flex-direction:column;gap:4px;">
            <div style="font-size:12px;opacity:.8;">Name</div>
            <input id="nameInput" maxlength="20" placeholder="Anonymous"
              style="width:220px;padding:8px 10px;border:1px solid #ddd;border-radius:10px;font-size:14px;box-sizing:border-box;" />
          </div>
        </div>

        <div style="flex:1;min-width:260px;">
          <div style="font-size:12px;opacity:.8;margin-bottom:6px;">Your comment</div>
          <textarea id="commentInput" maxlength="100"
            placeholder="Write a comment (max 100 characters)..."
            style="width:100%;height:92px;resize:vertical;padding:10px 12px;border:1px solid #ddd;border-radius:10px;font-size:14px;box-sizing:border-box;"></textarea>

          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:10px;flex-wrap:wrap;">
            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
              <button id="emojiBtn" type="button"
                style="border:1px solid #ddd;background:#fff;border-radius:10px;padding:8px 10px;cursor:pointer;">
                üòÄ Emoji
              </button>

              <div id="emojiPanel" style="display:none;position:relative;">
                <div style="position:absolute;z-index:9999;top:6px;left:0;width:360px;max-width:86vw;background:#fff;border:1px solid #ddd;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.08);padding:10px;">
                  <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
                    <input id="emojiSearch" placeholder="Search emoji"
                      style="flex:1;padding:8px 10px;border:1px solid #ddd;border-radius:10px;font-size:13px;box-sizing:border-box;" />
                    <button id="emojiClose" type="button"
                      style="border:1px solid #ddd;background:#fff;border-radius:10px;padding:8px 10px;cursor:pointer;">
                      Close
                    </button>
                  </div>
                  <div id="emojiGrid"
                    style="display:grid;grid-template-columns:repeat(9,1fr);gap:6px;max-height:260px;overflow:auto;padding-right:4px;">
                  </div>
                </div>
              </div>
            </div>

            <div style="display:flex;align-items:center;gap:10px;">
              <div id="charCount" style="font-size:12px;opacity:.75;">0 / 100</div>
              <button id="postBtn" type="button"
                style="padding:9px 14px;border:none;border-radius:10px;background:#111;color:#fff;cursor:pointer;">
                Post
              </button>
            </div>
          </div>

          <div style="margin-top:8px;font-size:12px;opacity:.7;">
            Ctrl+Enter to post
          </div>
        </div>
      </div>
    </div>

    <div id="commentsList" style="margin-top:16px;"></div>
  </div>

<script>
(() => {
  const API_URL = "https://script.google.com/macros/s/AKfycbx9QhQWo6rJBHMmdZ8D2yDA5395N5-LZlXm4JxuozBZV8K1koyOKoGgwkZ_x-tgeyB_/exec";

  const el = (id) => document.getElementById(id);

  const nameInput = el("nameInput");
  const commentInput = el("commentInput");
  const postBtn = el("postBtn");
  const notice = el("notice");
  const totalCount = el("totalCount");
  const commentsList = el("commentsList");
  const charCount = el("charCount");

  const adminBar = el("adminBar");
  const postAsAuthor = el("postAsAuthor");

  const emojiBtn = el("emojiBtn");
  const emojiPanel = el("emojiPanel");
  const emojiGrid = el("emojiGrid");
  const emojiSearch = el("emojiSearch");
  const emojiClose = el("emojiClose");
  const threadLabel = el("threadLabel");

  const params = new URLSearchParams(location.search);
  const postId =
    (params.get("post") || "").trim() ||
    (document.referrer || "").trim() ||
    "default_post";

  const adminKey = (params.get("admin") || "").trim();
  threadLabel.textContent = postId && postId !== "default_post" ? ("Thread: " + postId) : "";

  const NAME_KEY = "sc_name_v1";
  const DEVICE_KEY = "sc_device_v1";

  function setNotice(text, kind) {
    notice.textContent = text || "";
    notice.style.padding = text ? "10px 12px" : "0";
    notice.style.borderRadius = "10px";
    notice.style.border = text ? "1px solid #e6e6e6" : "none";
    notice.style.background = kind === "bad" ? "#fff3f3" : (kind === "good" ? "#f3fff7" : "#f7f7f7");
    notice.style.color = kind === "bad" ? "#7a1c1c" : (kind === "good" ? "#0f5132" : "#333");
  }

  function safeJson(res) {
    return res.json().catch(() => ({ ok:false, error:"Bad JSON from server" }));
  }

  function getDeviceId() {
    let id = "";
    try { id = localStorage.getItem(DEVICE_KEY) || ""; } catch {}
    if (!id) {
      id = "d_" + Date.now() + "_" + Math.random().toString(16).slice(2);
      try { localStorage.setItem(DEVICE_KEY, id); } catch {}
    }
    return id;
  }

  function getSavedName() {
    try { return (localStorage.getItem(NAME_KEY) || "").trim(); } catch { return ""; }
  }

  function saveName(v) {
    try { localStorage.setItem(NAME_KEY, v); } catch {}
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function formatDate(iso) {
    const d = new Date(iso);
    const days = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const dd = days[d.getDay()];
    const day = d.getDate();
    const mon = months[d.getMonth()];
    const yr = d.getFullYear();
    const hh = String(d.getHours()).padStart(2, "0");
    const mm = String(d.getMinutes()).padStart(2, "0");
    return dd + " " + day + " " + mon + " " + yr + ", " + hh + ":" + mm;
  }

  const EMOJIS = [
    "üòÄ","üòÉ","üòÑ","üòÅ","üòÜ","üòÖ","üòÇ","ü§£","üòä","üòá","üôÇ","üòâ","üòç","ü•∞","üòò","üòó","üòô","üòö",
    "üòã","üòõ","üòú","ü§™","üòù","üòé","ü§ì","üßê","ü§®","üòê","üòë","üò∂","ü´•","üòè","üòí","üôÑ","üò¨",
    "ü§•","üòå","üòî","üò™","ü§§","üò¥","üò∑","ü§í","ü§ï","ü§¢","ü§Æ","ü§ß","ü•µ","ü•∂","ü•¥","üòµ","üòµ‚Äçüí´",
    "ü§Ø","ü§†","ü•≥","üò≥","ü•∫","üò≠","üò¢","üò§","üò°","ü§¨","üò±","üò®","üò∞","üò•","üòì","ü§ó","ü´°",
    "üôè","ü§ù","ü´∂","üëè","üôå","üëç","üëé","‚úåÔ∏è","ü§û","ü§ü","ü§ò","üëå","ü´∞","üëÄ","üíÄ","üß†",
    "‚ù§Ô∏è","ü©∑","üß°","üíõ","üíö","üíô","ü©µ","üíú","ü§ç","üñ§","ü§é","üíî","‚ù§Ô∏è‚Äçüî•","‚ù§Ô∏è‚Äçü©π","üíØ","üî•","‚ú®","‚≠ê","üåü",
    "‚úÖ","‚ùå","‚ö†Ô∏è","‚ùì","‚ùó","üí¨","üóØÔ∏è","üìå","üìé","üìù","üì£","üéØ","‚è≥","üï∞Ô∏è",
    "üéâ","üéä","üéÅ","üéà","üéµ","üé∂","üéß","üé¨","üì∑","üçø","üßã","‚òï","üçî","üçü","üçï","üåç","üïäÔ∏è",
    "üèÄ","‚öΩ","üèÜ","ü•á","ü•à","ü•â"
  ];

  function renderEmojiGrid(list) {
    emojiGrid.innerHTML = "";
    list.forEach(em => {
      const b = document.createElement("button");
      b.type = "button";
      b.textContent = em;
      b.style.border = "1px solid #eee";
      b.style.background = "#fff";
      b.style.borderRadius = "10px";
      b.style.padding = "8px 0";
      b.style.cursor = "pointer";
      b.style.fontSize = "18px";
      b.addEventListener("click", () => insertEmoji(em));
      emojiGrid.appendChild(b);
    });
  }

  function insertEmoji(em) {
    const start = commentInput.selectionStart || 0;
    const end = commentInput.selectionEnd || 0;
    const v = commentInput.value || "";
    const next = (v.slice(0,start) + em + v.slice(end)).slice(0,100);
    commentInput.value = next;
    const cursor = Math.min(start + em.length, 100);
    commentInput.focus();
    commentInput.setSelectionRange(cursor, cursor);
    updateCharCount();
  }

  function updateCharCount() {
    if (commentInput.value.length > 100) commentInput.value = commentInput.value.slice(0,100);
    charCount.textContent = commentInput.value.length + " / 100";
  }

  async function apiGetList() {
    const url = API_URL + "?action=list&postId=" + encodeURIComponent(postId) +
      (adminKey ? "&adminKey=" + encodeURIComponent(adminKey) : "");
    const res = await fetch(url, { method: "GET" });
    return safeJson(res);
  }

  async function apiPost(payload) {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    return safeJson(res);
  }

  function reactedKey(commentId) {
    return "sc_reacted_v1::" + postId + "::" + commentId;
  }

  function hasReacted(commentId) {
    try { return !!localStorage.getItem(reactedKey(commentId)); } catch { return false; }
  }

  function setReacted(commentId, kind) {
    try { localStorage.setItem(reactedKey(commentId), kind); } catch {}
  }

  function render(data) {
    commentsList.innerHTML = "";

    if (data.isAdmin) adminBar.style.display = "block";
    totalCount.textContent = String(Number(data.totalVisible || 0));

    const comments = Array.isArray(data.comments) ? data.comments : [];
    if (!comments.length) {
      const empty = document.createElement("div");
      empty.style.padding = "14px 4px";
      empty.style.opacity = ".75";
      empty.textContent = "No comments yet.";
      commentsList.appendChild(empty);
      return;
    }

    comments.forEach(c => {
      const isAuthor = (c.role || "") === "author";
      const isPending = (c.status || "") === "pending";

      const badge = isAuthor
        ? `<span style="margin-left:8px;font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid #ddd;background:#f7f7f7;">Author</span>`
        : "";

      const pendingTag = isPending
        ? `<span style="margin-left:8px;font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid #f0c2c2;background:#fff3f3;color:#7a1c1c;">Pending</span>`
        : "";

      const reacted = hasReacted(c.commentId);
      const disabledStyle = reacted ? "opacity:.55;cursor:not-allowed;" : "cursor:pointer;";

      const adminButtons = adminKey
        ? `
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            ${isPending ? `<button data-act="approve" data-id="${c.commentId}" style="border:1px solid #ddd;background:#fff;border-radius:10px;padding:6px 10px;cursor:pointer;">Approve</button>` : ""}
            <button data-act="delete" data-id="${c.commentId}" style="border:1px solid #ddd;background:#fff;border-radius:10px;padding:6px 10px;cursor:pointer;">Delete</button>
          </div>
        `
        : "";

      const card = document.createElement("div");
      card.style.border = "1px solid #e6e6e6";
      card.style.borderRadius = "12px";
      card.style.padding = "12px";
      card.style.marginTop = "10px";
      card.style.background = "#fff";

      card.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;flex-wrap:wrap;">
          <div style="display:flex;align-items:center;gap:10px;">
            <div style="width:34px;height:34px;border-radius:999px;display:grid;place-items:center;background:#f2f2f2;border:1px solid #e6e6e6;">üë§</div>
            <div>
              <div style="font-size:13px;">
                <b>${escapeHtml(c.name || "Anonymous")}</b>
                ${badge}
                ${pendingTag}
              </div>
              <div style="font-size:12px;opacity:.7;">${formatDate(c.createdAtISO)}</div>
            </div>
          </div>

          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            <div style="display:flex;gap:8px;align-items:center;">
              <button data-act="like" data-id="${c.commentId}" style="border:1px solid #ddd;background:#fff;border-radius:999px;padding:6px 10px;${disabledStyle}">
                üëç ${Number(c.likes || 0)}
              </button>
              <button data-act="dislike" data-id="${c.commentId}" style="border:1px solid #ddd;background:#fff;border-radius:999px;padding:6px 10px;${disabledStyle}">
                üëé ${Number(c.dislikes || 0)}
              </button>
            </div>
            ${adminButtons}
          </div>
        </div>

        <div style="margin-top:10px;white-space:pre-wrap;word-break:break-word;">${escapeHtml(c.text || "")}</div>
      `;

      commentsList.appendChild(card);
    });
  }

  async function refresh() {
    try {
      const data = await apiGetList();
      if (!data.ok) {
        setNotice(data.error || "Could not load comments.", "bad");
        return;
      }
      setNotice("", "neutral");
      render(data);
    } catch {
      setNotice("Network error loading comments.", "bad");
    }
  }

  async function submit() {
    const text = (commentInput.value || "").trim();
    if (!text) return;

    const nm = (nameInput.value || "").trim().slice(0, 20);
    const name = nm ? nm : "Anonymous";
    saveName(name);

    const payload = {
      action: "add",
      postId,
      name,
      text: text.slice(0, 100),
      deviceId: getDeviceId()
    };

    if (adminKey) payload.adminKey = adminKey;
    if (adminKey && postAsAuthor && postAsAuthor.checked) payload.isAuthor = true;

    const data = await apiPost(payload);

    if (!data.ok) {
      if (data.error === "24h_limit") setNotice("You can only comment once every 24 hours on this post.", "bad");
      else setNotice(data.error || "Could not post comment.", "bad");
      return;
    }

    commentInput.value = "";
    updateCharCount();

    if (data.status === "pending") setNotice("Comment submitted. Approve it in Google Sheets to show it.", "good");
    else setNotice("Comment posted.", "good");

    refresh();
  }

  async function onClick(e) {
    const btn = e.target.closest("button[data-act][data-id]");
    if (!btn) return;

    const act = btn.getAttribute("data-act");
    const id = btn.getAttribute("data-id");

    if (act === "like" || act === "dislike") {
      if (hasReacted(id)) return;
      const data = await apiPost({ action:"react", postId, commentId:id, kind: act === "like" ? "like" : "dislike" });
      if (!data.ok) {
        setNotice(data.error || "Could not react.", "bad");
        return;
      }
      setReacted(id, act);
      refresh();
      return;
    }

    if (!adminKey) return;

    if (act === "approve") {
      const data = await apiPost({ action:"approve", postId, commentId:id, adminKey });
      if (!data.ok) setNotice(data.error || "Could not approve.", "bad");
      else refresh();
      return;
    }

    if (act === "delete") {
      const data = await apiPost({ action:"delete", postId, commentId:id, adminKey });
      if (!data.ok) setNotice(data.error || "Could not delete.", "bad");
      else refresh();
      return;
    }
  }

  nameInput.value = getSavedName() || "Anonymous";
  nameInput.addEventListener("input", () => saveName((nameInput.value || "").slice(0, 20)));

  commentInput.addEventListener("input", updateCharCount);
  updateCharCount();

  postBtn.addEventListener("click", submit);
  commentInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) submit();
  });

  commentsList.addEventListener("click", onClick);

  emojiBtn.addEventListener("click", () => {
    const open = emojiPanel.style.display === "inline-block";
    emojiPanel.style.display = open ? "none" : "inline-block";
    if (!open) {
      emojiSearch.value = "";
      renderEmojiGrid(EMOJIS);
      setTimeout(() => emojiSearch.focus(), 0);
    }
  });

  emojiClose.addEventListener("click", () => { emojiPanel.style.display = "none"; });

  document.addEventListener("click", (e) => {
    const within = emojiPanel.contains(e.target) || emojiBtn.contains(e.target);
    if (!within) emojiPanel.style.display = "none";
  });

  emojiSearch.addEventListener("input", () => {
    const q = (emojiSearch.value || "").trim();
    if (!q) { renderEmojiGrid(EMOJIS); return; }
    // No names included, so keep full list for now
    renderEmojiGrid(EMOJIS);
  });

  renderEmojiGrid(EMOJIS);
  refresh();
})();
</script>
</body>
</html>
