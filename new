<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Comments</title>
</head>

<body style="margin:0;background:transparent;">
  <div style="max-width:760px;margin:20px auto;padding:0 12px;font-family:Arial,sans-serif;">
    
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3 style="margin:0;">Comments</h3>
      <div style="font-size:13px;opacity:.7;">Total: <span id="total">0</span></div>
    </div>

    <div id="msg" style="margin:10px 0;font-size:13px;"></div>

    <div style="border:1px solid #ddd;border-radius:12px;padding:12px;background:#fff;">
      <div style="display:flex;align-items:center;gap:10px;">
        <div style="width:34px;height:34px;border-radius:50%;display:grid;place-items:center;background:#eee;">ðŸ‘¤</div>
        <input id="name" placeholder="Anonymous" maxlength="20"
          style="flex:1;padding:8px;border:1px solid #ddd;border-radius:8px;">
      </div>

      <textarea id="text" maxlength="100"
        placeholder="Write a comment (max 100 characters)"
        style="width:100%;height:90px;margin-top:10px;padding:10px;border:1px solid #ddd;border-radius:10px;"></textarea>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">
        <div id="count" style="font-size:12px;opacity:.7;">0 / 100</div>
        <button id="post"
          style="padding:8px 14px;border:none;border-radius:10px;background:#111;color:#fff;cursor:pointer;">
          Post
        </button>
      </div>
    </div>

    <div id="list" style="margin-top:14px;"></div>
  </div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbx9QhQWo6rJBHMmdZ8D2yDA5395N5-LZlXm4JxuozBZV8K1koyOKoGgwkZ_x-tgeyB_/exec";

const params = new URLSearchParams(location.search);
const postId = params.get("post") || document.referrer || "default";

const nameEl = document.getElementById("name");
const textEl = document.getElementById("text");
const postBtn = document.getElementById("post");
const listEl = document.getElementById("list");
const msgEl = document.getElementById("msg");
const totalEl = document.getElementById("total");
const countEl = document.getElementById("count");

function deviceId() {
  let id = localStorage.getItem("comment_device_id");
  if (!id) {
    id = "d_" + Date.now() + "_" + Math.random().toString(16).slice(2);
    localStorage.setItem("comment_device_id", id);
  }
  return id;
}

function escapeHtml(s) {
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

function formatTime(iso) {
  const d = new Date(iso);
  return d.toLocaleString();
}

async function load() {
  const res = await fetch(API_URL + "?action=list&postId=" + encodeURIComponent(postId));
  const data = await res.json();

  if (!data.ok) {
    msgEl.textContent = data.error || "Error loading comments";
    return;
  }

  listEl.innerHTML = "";
  totalEl.textContent = data.totalVisible || 0;

  if (!data.comments.length) {
    listEl.innerHTML = "<div style='opacity:.6;padding:10px;'>No comments yet.</div>";
    return;
  }

  data.comments.forEach(c => {
    const div = document.createElement("div");
    div.style.border = "1px solid #ddd";
    div.style.borderRadius = "10px";
    div.style.padding = "10px";
    div.style.marginTop = "10px";
    div.innerHTML = `
      <div style="font-size:13px;">
        <b>${escapeHtml(c.name || "Anonymous")}</b>
        ${c.role === "author" ? "<span style='margin-left:6px;font-size:11px;'>Author</span>" : ""}
      </div>
      <div style="font-size:12px;opacity:.6;">${formatTime(c.createdAtISO)}</div>
      <div style="margin-top:6px;">${escapeHtml(c.text)}</div>
    `;
    listEl.appendChild(div);
  });
}

postBtn.onclick = async () => {
  const name = nameEl.value.trim() || "Anonymous";
  const text = textEl.value.trim();
  if (!text) return;

  const res = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      action: "add",
      postId,
      name,
      text,
      deviceId: deviceId()
    })
  });

  const data = await res.json();
  if (!data.ok) {
    msgEl.textContent = data.error || "Error posting comment";
    return;
  }

  msgEl.textContent = "Comment submitted for approval";
  textEl.value = "";
  countEl.textContent = "0 / 100";
  load();
};

textEl.addEventListener("input", () => {
  countEl.textContent = textEl.value.length + " / 100";
});

nameEl.value = localStorage.getItem("comment_name") || "Anonymous";
nameEl.oninput = () => localStorage.setItem("comment_name", nameEl.value);

load();
</script>
</body>
</html>
